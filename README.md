# Clair Analytics Engineer Assessment - Part II Documentation
#### üë®‚Äçüíª Author: Elijah Esmero

## rpt__user_lending_readiness - Field Derivations

| Column                           | Field Derivations                                                                                                                                                                                                                                                                                                                                                                                                             | Assumptions                               | Tests               |
|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|---------------------|
| user_id                          | No transformation applied                                                                                                                                                                                                                                                                                                                                                                                                     | Values are universally unique IDs         | Unique and not null |
| started_onboarding_at            | No transformation applied                                                                                                                                                                                                                                                                                                                                                                                                     | Timestamps are not in the future          | Not null            |
| enrollment_completed_at          | Isolated enrollment.pass events from the webhook logs table. In case there can be multiple enrollment.pass events for the same user (legitimate or not legitimately), retrieved the earliest enrollment.pass timestamp (as we only want 1 per user to  avoid duplication downstream) using PostgreSQL arrow operators to traverse the JSON object then converted the text into a timestamp using the to_timestamp() function. | Timestamp is after started_onboarding_at  |                     |
| has_completed_enrollment         | A case-when statement sets this column to true if the user's kyc_status (no transformation applied) equals 'Pass' and they have enrollment_completed_at populated, otherwise the column is set to false. Note that users with a blank kyc_status will have this field set as false.                                                                                                                                           |                                           |                     |
| first_loan_confirmed_at          | Aggregated loans on user_id and used the min() function on applied_at timestamps from loans  where the is_confirmed field = true                                                                                                                                                                                                                                                                                              | Timestamp is after started_onboarding_at  |                     |
| first_loan_fully_repaid_at       | Aggregated loans on user_id and used the min() function on first_loan_confirmed_at timestamps from loans                                                                                                                                                                                                                                                                                                                      | Timestamp is after started_onboarding_at  |                     |
| lifetime_loans_confirmed_count   | Aggregated loans on user_id and used the sum() function on a case when expression that evaluates to 1 if the loan is confirmed and 0 if it isn't. If a user_id has no loans this field defaults to 0 rather than a null.                                                                                                                                                                                                      |                                           |                     |
| lifetime_full_repaid_loan_amount | Aggregated loans on user_id and used the sum() function on a case when expression that evaluates to the loan amount if the loan is has the fully_repaid_at field populated and 0 if it isn't. If a user_id has no loans this field defaults to 0 rather than a null.                                                                                                                                                          | All amounts being aggregated are positive |                     |
| days_to_create_account           | Calculated the time difference between the enrollment_completed_at timestamp and the started_onboarding_at timestamp then extracted the day component using extract()                                                                                                                                                                                                                                                         |                                           |                     |
| days_to_first_loan               | Calculated the time difference between the first_loan_confirmed_at timestamp and the enrollment_completed_at timestamp then extracted the day component using extract()                                                                                                                                                                                                                                                       |                                           |                     |
| is_returning                     | A case-when statement sets this column to true if the first_loan_fully_repaid_at field is populated otherwise this column is set to false                                                                                                                                                                                                                                                                                     |                                           |                     |

## Data Quality

### EA_assignment_users
- ‚ùå Timestamps do not have timezones, this will lead to inaccuracies if loans are generated on servers across different timezones.
- ‚ùå kyc_status contains blanks. These should be converted to nulls to avoid being processed in downstream string manipulation logic or defaulted to a business-appropriate text value.
- ‚úÖ No duplicates on user_id

### EA_assignment_loans
- ‚ùå Timestamps do not have timezones, this will lead to inaccuracies if loans are generated on servers across different timezones.
- ‚ùå is_confirmed should be a timestamp (perhaps renamed to confirmed_at) otherwise when the loan was confirmed cannot be known unless the table is snapshotted at a regular cadence (and this will only be an approximation)

### EA_assignment_webhooks
- ‚ùå JSON being stored in a data is expensive to process as the whole string has to be searched to retrieve nested attributes. The structure is not guaranteed to be consistent between rows as the structure isn't enforced by the database like columns.
- ‚ùå Log metadata such as the timestamp are nested inside the JSON object, this will make it very expensive to filter or perform incremental loads
- ‚úÖ Timestamps have timezones

## Filters

- No filters have been applied other than to isolate enrollment events from the webhook log table. Left joins are used to avoid unintentional filtering.
